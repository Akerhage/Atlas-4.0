# Atlas v3.14 — Fullständig Systemaudit
**Datum:** 2026-03-01
**Utförd av:** Claude Code (Sonnet 4.6)
**Scope:** Backend, RAG-system, Frontend, Deployment

---

## Sammanfattning

| Allvarlighetsgrad | Agent 1 (DB/Server) | Agent 2 (RAG) | Agent 3 (Frontend) | Agent 4 (Config) | TOTALT |
|---|---|---|---|---|---|
| **KRITISK** | 3 | 8 | 2 | 4 | **17** |
| **VARNING** | 4 | 6 | 6 | 7 | **23** |
| **INFO** | 5 | 5 | 4 | 4 | **18** |

---

## AGENT 1 — Databas & Server

### KRITISKA

**K1 — err.message exponeras till klient**
- Fil: `routes/admin.js`
- Rader: 189, 225, 284, 298, 376, 432
- Problem: `res.status(500).json({ error: err.message })` skickar intern databasinfo till klienten. Kan läcka tabellnamn, kolumnnamn och schema-detaljer.
- Fix: Alltid returnera generiskt `"Internt serverfel"` och logga det faktiska felet server-side.

**K2 — Race condition i human_mode-lås**
- Fil: `server.js`
- Rader: 285, 808
- Problem: `humanModeLocks`-timeout på 3 sekunder är för kort. Två simultana requests (Socket + HTTP) kan båda passera låset innan det sätts, vilket kan trigga dubbla agent-tilldelningar.
- Fix: Öka timeout till 10 sekunder, eller ersätt in-memory lock med atomisk DB-update.

**K3 — db.run() utan error callback**
- Fil: `server.js`
- Rader: 681–682, 709–710
- Problem: Presence-updates (`is_online`, `last_seen`) saknar error callback. Misslyckade uppdateringar loggas aldrig — svårt att debugga användarstatus-problem.
- Fix: Lägg till `(err) => { if (err) console.error('[DB] Presence update failed:', err); }`

### VARNINGAR

**V1 — Saknat index på `ticket_notes.conversation_id`**
- Fil: `db.js` (~rad 158)
- Problem: `conversation_id` används i WHERE-clauses men saknar index. N+1-problem vid hämtning av noteringar per ärende.

**V2 — Saknat index på `local_qa_history.is_archived`**
- Fil: `db.js` (~rad 227)
- Problem: `is_archived` används i WHERE men saknar index. Långsam filtrering vid stor QA-historik.

**V3 — Saknat index på `rag_failures.created_at`**
- Fil: `db.js` (~rad 174)
- Problem: `created_at` används i ORDER BY utan index.

**V4 — HTML-servering utan token-kontroll**
- Fil: `server.js` (~rad 605)
- Problem: Admin-gränssnittet servas som statisk HTML utan auth-kontroll. Relevant om appen exponeras på VPS utan reverse proxy.

### INFO

- SQL-injection: Välskyddad via whitelisting + parametrized queries genomgående.
- Brute-force: 5 försök / 15 min implementerat på login.
- Rollkontroll: Konsekvent i admin-routes.
- Socket.io cleanup: Automatisk — inga läckor.
- JWT_SECRET, EMAIL_PASS, NGROK_TOKEN exponeras aldrig i API-svar.

---

## AGENT 2 — RAG & Kunskapssystem

### KRITISKA

**K1 — `keywords.some()` utan null-check → servercrasch**
- Fil: `legacy_engine.js`
- Rad: ~1219
- Problem: Om en JSON-fil har `"keywords": null` istället för `[]` kastar `.some()` ett RuntimeError: "Cannot read property 'some' of null". Kraschar hela RAG-motorn.
- Fix: `(chunk.keywords || []).some(kw => ...)` på rad 1219 och alla liknande platser.

**K2 — `price`-fält utan typkontroll**
- Fil: `utils/priceResolver.js`
- Rader: 72, 95
- Problem: `Number(undefined)` = NaN, `NaN > 0` = false. Chunks med saknat price-fält silently skippas utan felmeddelande.
- Fix: Explicit kontroll `typeof c.price !== 'undefined'` innan `Number(c.price)`.

**K3 — `chunk.type` antas finnas utan null-check**
- Fil: `legacy_engine.js`
- Rader: 1686–1687
- Problem: Chunks som saknar `type`-fält i JSON-filen kan ge fel prioritering i scoring-logiken.
- Fix: Lägg till `(chunk.type || '')` på alla platser där `chunk.type` jämförs.

**K4 — `clearTimeout()` anropas ej vid exception i fallback**
- Fil: `utils/transportstyrelsen-fallback.js`
- Rad: ~124
- Problem: Om `fetch()` kastar exception innan `clearTimeout()` körs lämnas timern aktiv → memory leak. Dessutom försöker catch-blocket läsa `response.status` när `response` är undefined vid abort.
- Fix: Wrappa i try/finally: `finally { clearTimeout(timeoutId); }`

**K5 — Fallback-fetch blockerar event loop**
- Fil: `utils/transportstyrelsen-fallback.js`
- Rad: ~180
- Problem: `await fetchAndCleanPage(url)` kallas direkt i en Express route-handler. Om Transportstyrelsen.se svarar långsamt (upp till 8 sek timeout) blockeras ALLA andra användares requests under denna tid.
- Fix: Kör fallback i bakgrunden och returnera ett preliminary svar, eller sätt hårdare timeout på 3 sek.

**K6 — Motstridiga scoring-system (`finalScore` vs `forcedScore`)**
- Fil: `legacy_engine.js`
- Rader: 1471, 1804
- Problem: Intent-boost-systemet lägger till `finalScore` (+50 000) och mustAddChunks-systemet sätter `forcedScore` (25 000) separat. `forcedScore` via `topResultsMap.set()` kan skriva över `finalScore` beroende på körordning → oprediktabla svar.
- Fix: Integrera scoring-systemen eller definiera tydlig prioritetsordning.

**K7 — `hasSniperMatch = true` kan sättas 5× per loop**
- Fil: `legacy_engine.js`
- Rader: 1659–1903
- Problem: `hasSniperMatch` sätts till `true` av upp till 5 separata if-grenar i `mustAddChunks.forEach()`. Flaggan dämpar sedan kontor-boost för ALLA chunks. Om en "enkel" sniper-match triggas av oväntad anledning dämpas kontor-boost oavsiktligt.
- Fix: Inför separata flaggor (t.ex. `hasStrictPriceMatch`, `hasOfficeMatch`) istf gemensam `hasSniperMatch`.

**K8 — Race condition: `allChunks` kan vara tom vid uppstart**
- Fil: `legacy_engine.js`
- Rader: 185, 202
- Problem: `allChunks = []` vid modulstart. Om en request kommer in innan JSON-filerna hunnit laddas returneras tomma svar utan felindikation.
- Fix: Lägg till ready-flag och returnera 503 om motorn inte är initialiserad.

### VARNINGAR

**V1 — `topResults.length === 0` hanteras ej korrekt**
- Fil: `legacy_engine.js`, rad ~1836
- Problem: Tomma results loggas men koden fortsätter, vilket kan ge undefined access längre ned.

**V2 — Ingen retry-logik vid fallback-fetch**
- Fil: `utils/transportstyrelsen-fallback.js`
- Problem: Enstaka nätverksfel misslyckas permanent utan retry.

**V3 — `sessionId = undefined` ger svårdebuggar fel**
- Fil: `utils/contextLock.js`
- Problem: Saknad inputvalidering av sessionId — ger kryptiska fel längre i kedjan.

**V4 — `cityChanged` edge case med tomsträng**
- Fil: `utils/contextLock.js`, rad 61
- Problem: Om `explicitCity = ""` (tomsträng) behandlas det som falsy → gammal stad behålls felaktigt.

**V5 — O(n²) lookup med `allChunks.find()` i filter-loop**
- Fil: `legacy_engine.js`, rad ~1437
- Problem: `allChunks.find(c => c.id === result.id)` i en forEach-loop = O(n²). Vid 5 000 chunks ≈ 25M operationer per request.
- Fix: Använd redan initialiserade `chunkMap` (Map) för O(1) lookup.

**V6 — Kunskapsbasen uppdateras ej utan omstart**
- Fil: `legacy_engine.js`, rad 185
- Problem/Info: JSON-filer cachas globalt vid start. Uppdateringar till knowledge-mappen kräver serveromstart.

---

## AGENT 3 — Frontend & Säkerhet

### KRITISKA

**K1 — XSS i `formatAtlasMessage()`**
- Fil: `Renderer/renderer.js`
- Rader: 960–965
- Problem: `${alt}` (bildbeskrivning) och `${name}` (filnamn) injiceras i HTML-strängar utan escaping. En komprometterad server eller MITM-attack kan injicera JavaScript via bildlänkar eller filnamn.
- Fix: Kör `adminEscapeHtml()` på `alt` och `name` innan de injiceras i HTML.

**K2 — authToken lagras i `localStorage`**
- Fil: `Renderer/renderer.js`
- Rader: 80, 197, 318
- Problem: `localStorage` är åtkomlig från JavaScript. Om en XSS-bugg existerar kan token stjälas. Bör ersättas med `sessionStorage` eller HttpOnly-cookies.
- Fix (kort sikt): Byt till `sessionStorage`. Fix (lång sikt): HttpOnly-cookies via server.

### VARNINGAR

**V1 — `onclick`-injection i admin-users**
- Fil: `Renderer/modules/admin/admin-users.js`
- Rader: 119, 172
- Problem: `JSON.stringify(u)` och `u.username` injiceras i inline onclick-handlers utan escaping. Enkelfnutt i username kan bryta ut ur attributet.
- Fix: Använd `data-*`-attribut + `addEventListener()` istf inline onclick.

**V2 — `onclick`-injection i admin-offices**
- Fil: `Renderer/modules/admin/admin-offices.js`, rad 39
- Problem: `o.routing_tag` från server injiceras direkt i onclick utan escaping.

**V3 — `previewText` med `stripHtml()` ej `esc()`**
- Fil: `Renderer/modules/inbox-view.js`, rad 258
- Problem: Preview-text strippar HTML men escpar ej specialtecken — möjlig XSS-vektor.

**V4 — `contextBridge.send()` är generisk**
- Fil: `Renderer/preload.js`, rad 16
- Problem: `send(channel, data)` vidarebefordrar godtycklig IPC-kanal. Bör begränsas till en whitelist av tillåtna kanaler.

**V5 — Socket-data sätts utan typkontroll**
- Fil: `Renderer/modules/socket-client.js`, rad ~145
- Problem: `data.locked_context` sätts direkt på session-objekt utan validering av typ eller struktur.

**V6 — `setTimeout` för auto-logout sparas ej**
- Fil: `Renderer/renderer.js`, rad 302
- Problem: Timer-referens sparas inte → kan aldrig clearas vid manuell logout.

### INFO

- `adminEscapeHtml()` används konsekvent i admin-knowledge.js — bra.
- `container.innerHTML = ''` rensar gamla listeners korrekt — inga listener-läckor.
- Customer/team-socket är separata anslutningar — kund-socket kan ej trigga team-events.
- Fetch-anrop har try/catch konsekvent genomgående.

---

## AGENT 4 — Konfiguration & Deployment

### KRITISKA

**K1 — Hårdkodad `C:\\Atlas`-sökväg**
- Fil: `legacy_engine.js`, rad 28
- Problem: `const DEV_PATH = 'C:\\Atlas'` — fungerar ENDAST på detta Windows-system. Blockerar all Linux-deployment fullständigt.
- Fix: Ta bort DEV_PATH helt. Använd `process.env.ATLAS_ROOT_PATH || path.join(__dirname, '..')`.

**K2 — API-key null-check saknas → admin-bypass**
- Fil: `middleware/auth.js`, rad 18
- Problem: `if (apiKey && apiKey === process.env.CLIENT_API_KEY)` — om `CLIENT_API_KEY` ej är definierad i .env: `undefined === undefined` = `true` → alla requests med API-key-header får admin-roll.
- Fix: `if (apiKey && process.env.CLIENT_API_KEY && apiKey === process.env.CLIENT_API_KEY)`

**K3 — `.env` packas in i ASAR-paketet**
- Fil: `package.json`, rader 148–150
- Problem: Alla secrets (OpenAI-nyckel, GitHub-token, email-lösenord, JWT-secret) är åtkomliga för vem som helst som dekompilerar `.asar`-filen.
- Fix: Exkludera `.env` från ASAR-paketering. Läs secrets från OS-miljövariabler vid runtime.

**K4 — Ngrok krävs för extern åtkomst, ingen fallback**
- Fil: `main.js`, rader 212–244
- Problem: Ingen HTTPS-lösning utan ngrok. `ngrok.exe` är Windows-binär — fungerar ej på Linux.
- Fix (VPS): Nginx + Let's Encrypt eller Caddy som reverse proxy.

### VARNINGAR

**V1 — JWT_SECRET är svag och manuellt skapad**
- Fil: `.env`, rad 6 (`at1asjwtadmins2026`)
- Fix: `node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"`

**V2 — Brute-force-skydd är in-memory**
- Fil: `server.js`
- Problem: `loginAttempts`-Map nollställs vid varje omstart. Angripare kan kringgå skyddet genom att triggra en omstart.

**V3 — Socket.IO CORS: `origin: "*"`**
- Fil: `server.js`, rad ~517
- Fix: `origin: process.env.ALLOWED_ORIGIN || 'http://localhost:3001'`

**V4 — CSP innehåller `'unsafe-eval'` + öppen `img-src`**
- Fil: `main.js`, rad ~178
- Problem: `'unsafe-eval'` tillåter eval() vilket ökar XSS-risk. `img-src: http: https:` laddar bilder från valfri URL.

**V5 — Backup utan SQLite BACKUP API**
- Fil: `server.js`
- Problem: `fs.copyFileSync()` på aktiv databas kan ge inkonsistent snapshot. Bör använda SQLite `.backup()`-metoden.

**V6 — Databasen är okrypterad**
- Fil: `atlas.db`
- Problem: Plaintext SQLite — all kunddata exponeras vid serverintrång.

**V7 — `process.cwd()` vs `__dirname` blandas**
- Fil: `server.js`, rad 12
- Problem: I Electron-paket är `process.cwd()` inte garanterat `resourcesPath` vid dotenv-laddning.

### INFO

- EMAIL_PASS och NGROK_TOKEN loggas aldrig i klartext — bra.
- `process.platform`-check finns för Windows/Linux-kommandon.
- `__dirname`-baserade sökvägar används konsekvent i db.js och server.js.

---

## Top 5 — Måste fixas innan produktionsdrift (VPS)

| Prio | Problem | Fil | Tid |
|---|---|---|---|
| 1 | Hårdkodad `C:\\Atlas`-sökväg blockerar Linux | `legacy_engine.js:28` | 15 min |
| 2 | API-key null-check — potentiell admin-bypass | `middleware/auth.js:18` | 5 min |
| 3 | Socket.IO CORS öppen för alla | `server.js:517` | 5 min |
| 4 | Ngrok-beroende — ersätt med Nginx/Caddy | `main.js` | 2–4 tim |
| 5 | JWT_SECRET svag — generera kryptografisk | `.env` | 5 min |

---

## Top 5 — Måste fixas innan basprodukt (demo/beta)

| Prio | Problem | Fil | Tid |
|---|---|---|---|
| 1 | `keywords.some()` utan null-check → servercrasch | `legacy_engine.js:1219` | 15 min |
| 2 | Fallback-fetch blockerar event loop (8 sek) | `ts-fallback.js:180` | 30 min |
| 3 | `hasSniperMatch` överskriver kontor-boost felaktigt | `legacy_engine.js:1659` | 30–60 min |
| 4 | XSS i `formatAtlasMessage()` — `${alt}` oescapad | `renderer.js:960` | 20 min |
| 5 | `clearTimeout()` anropas ej vid exception | `ts-fallback.js:124` | 10 min |

---

## Deployment-checklista (VPS / Linux)

### Blockerande (måste fixas)
- [ ] Ta bort `C:\\Atlas` hårdkodning i `legacy_engine.js:28`
- [ ] Exkludera `.env` från ASAR-paketering
- [ ] Sätt `ATLAS_ROOT_PATH` i systemmiljövariabler
- [ ] Ersätt ngrok med Nginx + Let's Encrypt
- [ ] Fixa `CLIENT_API_KEY` null-check i `middleware/auth.js:18`

### Säkerhet (bör fixas)
- [ ] Generera ny slumpmässig JWT_SECRET
- [ ] Begränsa Socket.IO CORS till specifik origin
- [ ] Ta bort `'unsafe-eval'` från CSP
- [ ] Implementera SQLite `.backup()` API istf `fs.copyFileSync()`
- [ ] Whitelista `contextBridge.send()` kanaler i `preload.js`

### Nice-to-have
- [ ] Lägg till `/health`-endpoint för monitoring
- [ ] Strukturerad loggning (Winston/Pino)
- [ ] Rate limiting per endpoint
- [ ] Backup till extern storage (S3/Azure)
- [ ] systemd-service-fil för auto-start på Linux

---

*Rapport genererad automatiskt av Claude Code. Verifiera alla radnummer mot aktuell källkod innan åtgärd.*
